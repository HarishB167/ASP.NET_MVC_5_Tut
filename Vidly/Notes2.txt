ASP.NET MVC 5 : Part 2

Section 4 : Building Forms

1. The Markup
Add action to represent a form
In CustomerController add action named New.
Add it's view :
title and <h2> to New Customer
Render form :
.BeginForm returns Disposable object, so
using block makes </form> render on Dispose() call.
.LabelFor(<lambda expression>) - specifying model's property used.
.TextBoxFor - automatic supports validation from model, 2nd argument can be object to specify extra html properties.
@using (Html.BeginForm("targetAction", "ControllerName"))
{
    <div class="form-group">
          @Html.LabelFor(m => m.Name)
          @Html.TextBoxFor(m => m.Name, new { @class = "form-control" } )
    </div>
}

2. Form labels
Changing labels : 2 options :
1) Apply Data annotation in model as :
[Display(Name = "Date of  Birth")]
public DateTime? Birthdate {get; set;}
It requires recompiling at every change
2) Manually adding label as raw html
<label for="Birthdate">Date of Birth</label>
It requires adding for="" attribute to label
Change of model properties is not updated in 'for' attribute.

3. Drop-down Lists
- In application db context add DbSet for membership types.
public DbSet<MembershipType> MembershipTypes {get; set;}

- Create a ViewModel for this action having Membership types and Customer having property as NewCustomerViewModel
public IEnumerable<MembershipType> MembershipTypes {get; set;}
public Customer Customer {get; set;}

- In action method :
Getting membership types from database
var membershipTypes = _context.MembershipTypes.ToList();
Using view model :
var viewModel = new NewCustomerViewModel
{ MembershipTypes = membershipTypes
};

- In view .cshtml file
change @model ...NewCustomerViewModel
Add select form group
@Html.DropDownListFor(lambda function, 
new SelectList(list of items, value property, display property),
"Select membership type",
new {@class = "form-control"})

-  In Customer model
Using Data annotation set display value of MembershipTypeId to Membership Type.

4. Model Binding
- Add button to form
<button type="submit" class="btn btn-primary">Save</button>

- Create action
Apply [HttpPost] attribute - makes accept only Post request
Action modifying data should not accept get request.
Add parameter to action
public ActionResult Create(NewCustomerViewModel viewModel)
{
    return View();
}
Model binding - ASP.NET automatically binds request data to the model parameter


5. Saving Data
- First add it to DbContext as :
_context.Customers.Add(customer);
It's not written to database, it is in memory.
Changes are marked in DbContext.

- To persist changes :
_context.SaveChanges()
It generates SQL statements based on all changes in DbContext
and applies to database.
They are wrapped around transaction (Either all will be persisted on no one will).

- Redirect to List of customers
return RedirectToAction("Index", "Customers");

6. Edit Form
- In ActionLink in Customes/Index.cshtml
change action Details to Edit

- Create Edit action
Rename NewCustomerViewModel to CustomerFormViewModel
Rename New.cshtml to CustomerForm.cshtml
Same changes in New action also.
public ActionResult Edit(int id)
{
var customer = _context.Customers.SingleOrDefault(c => c.Id == id);
if (customer == null)
    return HttpNotFound();
var viewModel = new CustomerFormViewModel
{
Customer = customer,
MembershipTypes = _context.MembershipTyeps.ToList()
};
return View("CustomerForm", viewModel);
}

- Fixing display of time component of birthdate
In TextBoxFor in CustomerForm.cshtml
Add format string at 2nd argument as :
"{0:d MMM yyyy}"

7. Updating Data
- In CustomerForm rename action Create to Save.
same rename in CustomersController.

- Updating customer object values : 2 ways :
1) TryUpdateModel(object) method :
• It opens security holes : unauthorized updation of properties
• Whitelisting creates magic strings.
2) Manual set properties of object (Preffered way)
customerInDb.Name = customer.Name; etc...

- Changing Save action
if (customer.Id == 0)
    _context.Customers.Add(customer)
else
{
    var customerInDb = _context.Customers.Single(c => c.Id == customer.Id);
    customerInDb.Name = customer.Name;
    customerInDb.Birthdate = customer.Birthdate;
    customerInDb.MembershipTypeId = customer.MembershipTypeId;
    customerInDb.IsSubscribedToNewsletter = customer.IsSubscribedToNewsletter;
}

- As we relying on customer id
Create id as hidden field before submit button in CustomerForm
@Html.HiddenFor(m => m.Customer.Id)

----------------------------------------------
Status - Section 4 - Updating Data - completed



